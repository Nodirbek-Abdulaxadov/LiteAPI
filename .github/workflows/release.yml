name: release

on:
  push:
    tags:
      - "v*"

jobs:
  build-native:
    name: Build Rust native (${{ matrix.rid }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            rid: win-x64
            target: x86_64-pc-windows-msvc
            artifact_name: liteapi_rust.dll
            dest_path: LiteAPI/runtimes/win-x64/native/liteapi_rust.dll
          - os: windows-latest
            rid: win-arm64
            target: aarch64-pc-windows-msvc
            artifact_name: liteapi_rust.dll
            dest_path: LiteAPI/runtimes/win-arm64/native/liteapi_rust.dll
          - os: ubuntu-latest
            rid: linux-x64
            target: x86_64-unknown-linux-gnu
            artifact_name: libliteapi_rust.so
            dest_path: LiteAPI/runtimes/linux-x64/native/libliteapi_rust.so
          - os: ubuntu-latest
            rid: linux-arm64
            target: aarch64-unknown-linux-gnu
            artifact_name: libliteapi_rust.so
            dest_path: LiteAPI/runtimes/linux-arm64/native/libliteapi_rust.so
          - os: macos-15-intel
            rid: osx-x64
            target: x86_64-apple-darwin
            artifact_name: libliteapi_rust.dylib
            dest_path: LiteAPI/runtimes/osx-x64/native/libliteapi_rust.dylib
          - os: macos-latest
            rid: osx-arm64
            target: aarch64-apple-darwin
            artifact_name: libliteapi_rust.dylib
            dest_path: LiteAPI/runtimes/osx-arm64/native/libliteapi_rust.dylib

    steps:
      - uses: actions/checkout@v4

      - uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install Linux cross deps
        if: runner.os == 'Linux' && matrix.rid == 'linux-arm64'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu binutils-aarch64-linux-gnu

      - name: Build (release)
        working-directory: LiteAPI/liteapi_rust
        shell: bash
        run: |
          set -euo pipefail

          # For linux-arm64 we must explicitly use the aarch64 linker.
          if [[ "${{ matrix.rid }}" == "linux-arm64" ]]; then
            export CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER=aarch64-linux-gnu-gcc
            export CC_aarch64_unknown_linux_gnu=aarch64-linux-gnu-gcc
            export AR_aarch64_unknown_linux_gnu=aarch64-linux-gnu-ar
          fi

          cargo build --release --target "${{ matrix.target }}"

      - name: Copy native into runtimes/
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p "$(dirname "${{ matrix.dest_path }}")"

          # Windows puts the dll under deps
          if [[ "${{ matrix.rid }}" == win-* ]]; then
            src1="LiteAPI/liteapi_rust/target/${{ matrix.target }}/release/deps/${{ matrix.artifact_name }}"
            src2="LiteAPI/liteapi_rust/target/${{ matrix.target }}/release/${{ matrix.artifact_name }}"
            if [[ -f "$src1" ]]; then
              cp "$src1" "${{ matrix.dest_path }}"
            elif [[ -f "$src2" ]]; then
              cp "$src2" "${{ matrix.dest_path }}"
            else
              echo "Native output not found" >&2
              exit 1
            fi
          else
            cp "LiteAPI/liteapi_rust/target/${{ matrix.target }}/release/${{ matrix.artifact_name }}" "${{ matrix.dest_path }}"
          fi

      - name: Upload native artifact
        uses: actions/upload-artifact@v4
        with:
          name: native-${{ matrix.rid }}
          path: ${{ matrix.dest_path }}
          if-no-files-found: error

  pack:
    name: Pack NuGet (cross-platform natives)
    needs: build-native
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Download native artifacts
        uses: actions/download-artifact@v4
        with:
          path: .native-artifacts

      - name: Place natives into runtimes/
        shell: bash
        run: |
          set -euo pipefail
          shopt -s globstar
          for f in .native-artifacts/native-*/LiteAPI/runtimes/**/native/*; do
            dest="${f#.native-artifacts/native-*/}"
            mkdir -p "$(dirname "$dest")"
            cp "$f" "$dest"
          done

      - name: Restore
        run: dotnet restore "./LiteAPI.sln"

      - name: Build
        run: dotnet build "./LiteAPI.sln" --configuration Release --no-restore

      - name: Test
        run: dotnet test "./LiteAPI.sln" --configuration Release --no-build

      - name: Pack
        run: dotnet pack "./LiteAPI/LiteAPI.csproj" --configuration Release --no-build

      - name: Upload nupkg
        uses: actions/upload-artifact@v4
        with:
          name: nupkg
          path: LiteAPI/bin/Release/*.nupkg
          if-no-files-found: error

  push-nuget:
    name: Push to NuGet
    needs: pack
    runs-on: ubuntu-latest
    env:
      NUGET_API_KEY: ${{ secrets.NUGET_API_KEY }}

    steps:
      - name: Skip (no NuGet key)
        if: ${{ env.NUGET_API_KEY == '' }}
        run: echo "NUGET_API_KEY is not set; skipping NuGet push."

      - uses: actions/download-artifact@v4
        if: ${{ env.NUGET_API_KEY != '' }}
        with:
          name: nupkg
          path: nupkg

      - uses: actions/setup-dotnet@v4
        if: ${{ env.NUGET_API_KEY != '' }}
        with:
          dotnet-version: 9.0.x

      - name: Push
        if: ${{ env.NUGET_API_KEY != '' }}
        run: dotnet nuget push "nupkg/*.nupkg" --api-key "$NUGET_API_KEY" --source "https://api.nuget.org/v3/index.json" --skip-duplicate
